% Section V Experiment

% Please Refer to:

% Liao Wu, Hongliang Ren. Finding the kinematic base frame of a robot by 
% hand-eye calibration using 3D position data. IEEE Transactions on 
% Automation Science and Engineering. 2017, 14(1): 314-324.

close all;
clear;
clc;

%% calibrate the robot
CalibrateLBR;

%% measurement data

%joint variables of the robot in each configuration
q_rob = [
1	-0.4764441	-1.737984223	-1.753670934	1.420890295	-0.539527088	-1.787163742	0.313323495
2	-2.792323944	-0.893698437	-0.534636508	-0.456348748	-1.400310366	1.379630692	-1.04092173
3	-2.595425173	-1.774287803	-1.557848686	-0.759522648	-0.760147498	-1.874186055	-0.889038727
4	-2.334251399	-1.707502786	1.742090596	-1.274254911	1.36619976	1.830954375	-2.698086732
5	-2.315435751	0.584394373	-2.165163161	1.222991704	0.099302624	-1.124872628	-1.327953395
6	-1.77909658	-1.222420228	-2.535041518	0.991749809	-0.028216109	1.971939572	-1.824163183
7	-1.56495171	1.162066229	0.199602514	1.654951329	0.261557103	-1.319791716	2.808735557
8	-1.525281722	-0.249500837	-0.958699964	-2.045918582	1.173496413	-0.235699802	-0.662234743
9	-1.42411953	0.385564432	2.327639435	-1.901212398	1.299188041	0.20437388	-2.624956903
10	-1.350763402	-0.622207377	-0.531688384	-1.854833845	-0.633888129	0.681312399	1.385235114
11	-1.342781257	-0.902831023	-0.709213937	-2.025580402	-2.776414022	-0.600745225	-1.234544439
12	-0.555363541	0.361269736	-1.171659634	1.320767199	-2.352656397	0.735289978	-2.375794997
13	-0.215396185	-1.727798739	-0.066267942	-1.982177828	-1.688808478	-1.85174177	1.87726175
14	-0.171973206	1.685960209	0.209510031	-0.355827583	1.079634416	-1.634839295	1.501870455
15	-0.133581926	-0.703798609	-1.937191657	1.68908572	2.065922319	1.073646996	1.48664184
16	-0.08201194	1.214262453	2.053811144	0.926648999	-1.150700573	1.742059279	2.432638526
17	0.071963414	1.800653411	-2.41884129	0.382922865	0.699817951	-1.006674771	1.007186898
18	0.128561871	1.24793689	0.494196814	-2.071633207	-1.281205336	-1.426824236	-1.89606849
19	0.445325066	0.60428671	2.039653095	0.16224347	2.070180876	-1.856500604	2.12486219
20	0.530549961	-0.836476005	1.170620432	1.890124511	1.305637699	-2.021138777	1.702775332
21	0.898151339	-1.681109121	1.707470622	1.51108978	1.046906961	-0.634750291	1.380868434
22	1.430491566	0.919443456	-0.525043645	-1.819698298	-1.943851813	1.932739381	-2.673661129
23	1.941976415	0.719248301	-0.672681078	-1.250769406	-1.629277884	1.734275991	2.230884133
24	2.009616935	-1.226995284	-2.709662981	1.281680514	2.180569676	1.314225833	-0.597269513
25	2.104129584	0.21029147	-0.082828057	1.859324345	1.249493195	-0.830560764	-0.908709492
26	2.182580999	-1.06300456	-1.945889384	-1.394881236	2.7075165	-1.500116595	1.296019124
27	2.378928383	-1.781486892	-0.309361364	-1.848547281	1.575061411	-1.401001849	1.253354749
28	2.396386195	0.919278475	-1.408076962	-2.06167462	-1.428237504	1.048986099	2.310937082
29	2.659768647	-1.990807037	1.283472263	1.70544793	1.502478029	-2.028798391	-1.09581351
];

q = q_rob(:,2:8) - repmat([0,0,0,-pi/2,0,pi/2,-138/180*pi],size(q_rob,1),1);

%homogeneous transformation from base frame to tool frame
g_rob = zeros(4,4,size(q_rob,1));
for i=1:size(q_rob,1)
    g_rob(:,:,i)=ForwardKinematics7(q(i,:),xi,gst);
end

%measurement of pose of the markers
Pose_meas = [
1 -0.559113 0.294376 -2.35687 -0.831801 -0.215534 0.342351 0.380063 -45.4768 8.31666 -47.1695    
2 -0.660834 0.389483 -1.84348 -0.651774 -0.121111 -0.0551233 -0.746649 97.1869 4.47897 14.638 
3 -0.632206 0.0629411 -1.44111 -0.791676 -0.521339 -0.261104 0.182427 -35.1427 70.8317 12.8974 
4 -0.0205828 -0.450883 -1.79078 -0.0266389 0.100103 -0.0864051 0.99086 -177.923 9.75436 11.7113 
5 0.729536 0.133102 -2.12349 -0.216574 -0.264284 0.344168 0.874528 -165.594 -38.025 -37.6852 
6 -0.800989 0.172408 -1.96733 -0.561185 0.226349 -0.145207 -0.782785 105.826 -29.3699 -11.0339 
7 -0.170021 0.231662 -2.49386 -0.581846 -0.108596 0.0796154 -0.802074 107.477 14.7698 4.67802 
8 0.351151 0.0872642 -2.7947 -0.0664384 -0.239213 -0.462294 0.851262 -159.129 60.7744 -20.233 
9 -0.545825 0.19503 -1.81304 -0.654257 -0.131501 -0.337657 -0.663809 97.9795 -20.5347 38.0546 
10 0.41896 0.284809 -2.50461 -0.276283 -0.333323 -0.311202 0.846001 -132.806 50.5859 -23.0805 
11 0.321744 0.416633 -2.56808 -0.639744 0.087429 0.270382 0.714127 -99.8102 -30.7088 -12.7725 
12 -0.733553 0.402118 -2.08736 -0.750821 0.231377 -0.16744 -0.595564 76.4317 -33.1647 -1.3847 
13 -0.435384 0.0499147 -2.4549 -0.612765 -0.0747913 -0.26865 -0.739428 105.358 -19.8965 26.0939 
14 0.361702 0.00726507 -1.52855 -0.775794 0.0208184 0.177598 0.605119 -77.8009 -14.7955 -14.499 
15 -0.554096 0.320644 -1.96381 -0.644955 -0.648276 -0.370502 -0.162785 -21.9052 99.135 43.5489 
16 0.131879 -0.119504 -1.31772 0.349241 -0.223949 0.517371 0.748468 130.994 -68.6249 1.49773 
17 -0.529867 -0.519657 -1.51142 -0.558793 -0.385386 0.0193161 -0.734067 95.366 33.1742 32.9708 
18 -0.655304 -0.229321 -1.82088 -0.761732 0.161054 -0.420177 -0.46613 75.9013 -46.9546 29.3393 
19 -0.479216 0.353772 -1.87691 0.494883 0.253205 -0.000451478 0.831251 114.897 16.0842 24.8666 
20 0.0852624 0.253584 -2.22212 -0.864524 -0.453561 0.101681 -0.191161 25.0093 55.3969 -0.137798 
21 0.51425 0.215743 -1.93241 -0.841714 -0.487047 -0.169885 0.159507 -25.9605 61.8429 7.50507 
22 -0.589335 0.202939 -1.73407 -0.901134 -0.414085 -0.0891357 0.0924465 -13.9625 49.95 4.82341 
23 -0.728175 0.331667 -1.87448 -0.752839 -0.580266 -0.300208 0.079996 -30.1572 80.9791 21.0498 
24 -0.021409 0.538693 -2.13911 -0.850526 -0.108818 -0.258121 -0.445127 56.133 -3.03419 32.4086 
25 0.463737 0.315876 -1.84822 -0.15283 -0.00724159 0.696243 0.70131 -167.904 -88.2138 -12.8836 
26 0.0938012 -0.265924 -1.79693 0.22822 0.206414 -0.0271169 0.951091 151.218 9.06989 22.3498 
27 -0.0602378 0.196799 -1.57017 0.419223 -0.145945 0.615097 0.651619 129.852 -77.7444 18.9974 
28 -0.504118 0.120437 -1.78386 -0.673083 -0.552499 -0.478833 -0.111458 -36.2707 96.1884 50.1522 
29 -0.252073 0.0805158 -1.61271 -0.886909 -0.275768 -0.314779 0.195598 -35.6676 43.3012 26.7746];

%homogeneous transformation from world frame to marker frame
g_meas = zeros(4,4,size(Pose_meas,1));

for i=1:size(Pose_meas,1)
    g_meas(:,:,i)=[-1 0 0 0;0 1 0 0; 0 0 1 0; 0 0 0 1]*[Q2R(Pose_meas(i,5:8)),Pose_meas(i,2:4)';
        0,0,0,1]*[-1 0 0 0;0 1 0 0; 0 0 1 0; 0 0 0 1];
end

%% find the base frame
for j=5:size(g_rob,3) % select j measurements
    
    j

    for k=1:100 % run 100 times 

        seri = randperm(size(g_rob,3));
        g_rob = g_rob(:,:,seri);
        g_meas = g_meas(:,:,seri);

        R_BH = g_rob(1:3,1:3,1:j);
        t_BH = g_rob(1:3,4,1:j);
        P_W = g_meas(1:3,4,1:j);
        P_W = reshape(P_W,3,[]);

        tic;
        [ R_BW_init, t_BW_init, P_H_init ] = closedForm( R_BH, t_BH, P_W );
        t_init(j-4)=toc;

        tic;
        [ R_BW, t_BW, P_H ] = iterative( R_BH, t_BH, P_W, R_BW_init, t_BW_init, P_H_init );
        t_iter(j-4)=toc;

        g_BH = g_rob(:,:,1:j);
        g_WM = g_meas(:,:,1:j);

        tic;
        [g_HM, g_BW] = AXYB_Kronecker(g_BH, g_WM);
        t_full(j-4)=toc;

        e_R_BW_init(j-4,k)=norm(vlogR(R_BW_init));
        e_R_BW(j-4,k)=norm(vlogR(R_BW));
        e_g_BW_R(j-4,k)=norm(vlogR(g_BW(1:3,1:3)));
        e_g_HM_R(j-4,k)=norm(vlogR(g_HM(1:3,1:3)));
        e_t_BW_init(j-4,k)=norm(t_BW_init);
        e_t_BW(j-4,k)=norm(t_BW);
        e_g_BW_t(j-4,k)=norm(g_BW(1:3,4));
        e_P_H_init(j-4,k)=norm(P_H_init);
        e_P_H(j-4,k)=norm(P_H);
        e_g_HM_t(j-4,k)=norm(g_HM(1:3,4));
    end

    meantime_init(j-4)=mean(t_init);
    meantime_iter(j-4)=mean(t_iter);
    meantime_full(j-4)=mean(t_full);

    mintime_init(j-4)=min(t_init);
    mintime_iter(j-4)=min(t_iter);
    mintime_full(j-4)=min(t_full);

    maxtime_init(j-4)=max(t_init);
    maxtime_iter(j-4)=max(t_iter);
    maxtime_full(j-4)=max(t_full);
end
%figure(1)
%plot(6:size(g_rob,3),median(e_R_BW_init(2:end,:),2),6:size(g_rob,3),median(e_R_BW(2:end,:),2),6:size(g_rob,3),median(e_g_BW_R(2:end,:),2))
%figure(2)
%plot(6:size(g_rob,3),median(e_t_BW_init(2:end,:),2),6:size(g_rob,3),median(e_t_BW(2:end,:),2),6:size(g_rob,3),median(e_g_BW_t(2:end,:),2))
%figure(3)
%plot(6:size(g_rob,3),median(e_P_H_init(2:end,:),2),6:size(g_rob,3),median(e_P_H(2:end,:),2),6:size(g_rob,3),median(e_g_HM_t(2:end,:),2))

figure(4) % fig. 7 (left)
plot(6:size(g_rob,3),mean(e_R_BW_init(2:end,:),2),6:size(g_rob,3),mean(e_R_BW(2:end,:),2),6:size(g_rob,3),mean(e_g_BW_R(2:end,:),2))
figure(5) % fig. 7 (middle)
plot(6:size(g_rob,3),mean(e_t_BW_init(2:end,:),2),6:size(g_rob,3),mean(e_t_BW(2:end,:),2),6:size(g_rob,3),mean(e_g_BW_t(2:end,:),2))
figure(6) % fig. 7 (right)
plot(6:size(g_rob,3),mean(e_P_H_init(2:end,:),2),6:size(g_rob,3),mean(e_P_H(2:end,:),2),6:size(g_rob,3),mean(e_g_HM_t(2:end,:),2))

figure(7) % fig. 8
hold on;
plot(6:size(g_rob,3),meantime_init(2:end),6:size(g_rob,3),meantime_iter(2:end),6:size(g_rob,3),meantime_full(2:end))